<html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"> <meta name="format-detection" content="telephone=no"> <title>16 | 浮点数和定点数（下）：深入理解浮点数到底有什么用？</title>         <style type="text/css"> html { color: #333; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; text-rendering: optimizelegibility; font-family: Helvetica Neue,PingFang SC,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif } html.borderbox *,html.borderbox :after,html.borderbox :before { box-sizing: border-box } article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul { margin: 0; padding: 0 } article,aside,details,figcaption,figure,footer,header,menu,nav,section { display: block } audio,canvas,video { display: inline-block } body,button,input,select,textarea { font: 300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif } button::-moz-focus-inner,input::-moz-focus-inner { padding: 0; border: 0 } table { border-collapse: collapse; border-spacing: 0 } fieldset,img { border: 0 } blockquote { position: relative; color: #999; font-weight: 400; border-left: 1px solid #1abc9c; padding-left: 1em; margin: 1em 3em 1em 2em } @media only screen and (max-width: 640px) { blockquote { margin:1em 0 } } abbr,acronym { border-bottom: 1px dotted; font-variant: normal } abbr { cursor: help } del { text-decoration: line-through } address,caption,cite,code,dfn,em,th,var { font-style: normal; font-weight: 400 } ol,ul { list-style: none } caption,th { text-align: left } q:after,q:before { content: "" } sub,sup { font-size: 75%; line-height: 0; position: relative } :root sub,:root sup { vertical-align: baseline } sup { top: -.5em } sub { bottom: -.25em } a { color: #1abc9c } a:hover { text-decoration: underline } .typo a { border-bottom: 1px solid #1abc9c } .typo a:hover { border-bottom-color: #555; color: #555 } .typo a:hover,a,ins { text-decoration: none } .typo-u,u { text-decoration: underline } mark { background: #fffdd1; border-bottom: 1px solid #ffedce; padding: 2px; margin: 0 5px } code,pre,pre tt { font-family: Courier,Courier New,monospace } pre { background: hsla(0,0%,97%,.7); border: 1px solid #ddd; padding: 1em 1.5em; display: block; -webkit-overflow-scrolling: touch } hr { border: none; border-bottom: 1px solid #cfcfcf; margin-bottom: .8em; height: 10px } .typo-small,figcaption,small { font-size: .9em; color: #888 } b,strong { font-weight: 700; color: #000 } [draggable] { cursor: move } .clearfix:after,.clearfix:before { content: ""; display: table } .clearfix:after { clear: both } .clearfix { zoom:1} .textwrap,.textwrap td,.textwrap th { word-wrap: break-word; word-break: break-all } .textwrap-table { table-layout: fixed } .serif { font-family: Palatino,Optima,Georgia,serif } .typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote { margin-bottom: 1rem } h1,h2,h3,h4,h5,h6 { font-family: PingFang SC,Helvetica Neue,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif; color: #000; line-height: 1.35 } .typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6 { margin-top: 1.2em; margin-bottom: .6em; line-height: 1.35 } .typo-h1,.typo h1 { font-size: 2em } .typo-h2,.typo h2 { font-size: 1.8em } .typo-h3,.typo h3 { font-size: 1.6em } .typo-h4,.typo h4 { font-size: 1.4em } .typo-h5,.typo-h6,.typo h5,.typo h6 { font-size: 1.2em } .typo-ul,.typo ul { margin-left: 1.3em; list-style: disc } .typo-ol,.typo ol { list-style: decimal; margin-left: 1.9em } .typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul { margin-bottom: .8em; margin-left: 2em } .typo-ol ul,.typo-ul ul,.typo li ul { list-style: circle } .typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th { border: 1px solid #ddd; padding: .5em 1em; color: #666 } .typo-table th,.typo table th { background: #fbfbfb } .typo-table thead th,.typo table thead th { background: hsla(0,0%,95%,.7) } .typo table caption { border-bottom: none } .typo-input,.typo-textarea { -webkit-appearance: none; border-radius: 0 } .typo-em,.typo em,caption,legend { color: #000; font-weight: inherit } .typo-em { position: relative } .typo-em:after { position: absolute; top: .65em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB" } .typo img { max-width: 100% } .common-content { font-weight: 400; color: #353535; line-height: 1.75rem; white-space: normal; word-break: normal; font-size: 1rem } .common-content img { display: block; max-width: 100%; background-color: #eee } .common-content audio,.common-content video { width: 100%; background-color: #eee } .common-content center,.common-content font { margin-top: 1rem; display: inline-block } .common-content center { width: 100% } .common-content pre { margin-top: 1rem; padding-left: 0; padding-right: 0; position: relative; overflow: hidden } .common-content pre code { font-size: .8rem; font-family: Consolas,Liberation Mono,Menlo,monospace,Courier; display: block; width: 100%; box-sizing: border-box; padding-left: 1rem; padding-right: 1rem; overflow-x: auto } .common-content hr { border: none; margin-top: 1.5rem; margin-bottom: 1.5rem; border-top: 1px solid #f5f5f5; height: 1px; background: none } .common-content b,.common-content h1,.common-content h2,.common-content h3,.common-content h4,.common-content h5,.common-content strong { font-weight: 700 } .common-content h1,.common-content h2 { font-size: 1.125rem; margin-bottom: .45rem } .common-content h3,.common-content h4,.common-content h5 { font-size: 1rem; margin-bottom: .45rem } .common-content p { font-weight: 400; color: #353535; margin-top: .15rem } .common-content .orange { color: #ff5a05 } .common-content .reference { font-size: 1rem; color: #888 } .custom-rich-content h1 { margin-top: 0; font-weight: 400; font-size: 15.25px; border-bottom: 1px solid #eee; line-height: 2.8 } .custom-rich-content li,.custom-rich-content p { font-size: 14px; color: #888; line-height: 1.6 } table.hljs-ln { margin-bottom: 0; border-spacing: 0; border-collapse: collapse } table.hljs-ln,table.hljs-ln tbody,table.hljs-ln td,table.hljs-ln tr { box-sizing: border-box } table.hljs-ln td { padding: 0; border: 0 } table.hljs-ln td.hljs-ln-numbers { min-width: 15px; color: rgba(27,31,35,.3); text-align: right; white-space: nowrap; cursor: pointer; user-select: none } table.hljs-ln td.hljs-ln-code,table.hljs-ln td.hljs-ln-numbers { font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace; font-size: 12px; line-height: 20px; vertical-align: top } table.hljs-ln td.hljs-ln-code { position: relative; padding-right: 10px; padding-left: 10px; overflow: visible; color: #24292e; word-wrap: normal; white-space: pre } video::-webkit-media-controls { overflow: hidden!important } video::-webkit-media-controls-enclosure { width: calc(100% + 32px); margin-left: auto } .button-cancel { color: #888; border: 1px solid #888; border-radius: 3px; margin-right: 12px } .button-cancel,.button-primary { -ms-flex-positive: 1; flex-grow: 1; height: 35px; display: inline-block; font-size: 15px; text-align: center; line-height: 36px } .button-primary { color: #fff; background-color: #ff5a05; border-radius: 3px } @font-face { font-family: iconfont; src: url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot); src: url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.woff) format("woff"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.ttf) format("truetype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.svg#iconfont) format("svg") } @font-face { font-family: player-font; src: url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot); src: url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.woff) format("woff"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.ttf) format("truetype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.svg#player-font) format("svg") } .iconfont { font-family: iconfont!important; font-size: 16px; font-style: normal; -webkit-font-smoothing: antialiased; -webkit-text-stroke-width: .2px; -moz-osx-font-smoothing: grayscale } html { background: #fff; min-height: 100%; -webkit-tap-highlight-color: rgba(0,0,0,0) } body { width: 100% } body.fixed { overflow: hidden; position: fixed; width: 100vw; height: 100vh } i { font-style: normal } a { word-wrap: break-word; -webkit-tap-highlight-color: rgba(0,0,0,0) } a:hover { text-decoration: none } .fade-enter-active,.fade-leave-active { transition: opacity .3s } .fade-enter,.fade-leave-to { opacity: 0 } .MathJax,.MathJax_CHTML,.MathJax_MathContainer,.MathJax_MathML,.MathJax_PHTML,.MathJax_PlainSource,.MathJax_SVG { outline: 0 } .ios-app-switch .js-audit { display: none } ._loading_wrap_ { position: fixed; width: 100vw; height: 100vh; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 999 } ._loading_div_class_,._loading_wrap_ { display: -ms-flexbox; display: flex; -ms-flex-pack: center; justify-content: center; -ms-flex-align: center; align-items: center } ._loading_div_class_ { word-wrap: break-word; padding: .5rem .75rem; text-align: center; z-index: 9999; font-size: .6rem; max-width: 60%; color: #fff; border-radius: .25rem; -ms-flex-direction: column; flex-direction: column } ._loading_div_class_ .message { color: #353535; font-size: 16px; line-height: 3 } .spinner { animation: circle-rotator 1.4s linear infinite } .spinner * { line-height: 0; box-sizing: border-box } @keyframes circle-rotator { 0% { transform: rotate(0deg) } to { transform: rotate(270deg) } } .path { stroke-dasharray: 187; stroke-dashoffset: 0; transform-origin: center; animation: circle-dash 1.4s ease-in-out infinite,circle-colors 5.6s ease-in-out infinite } @keyframes circle-colors { 0% { stroke: #ff5a05 } to { stroke: #ff5a05 } } @keyframes circle-dash { 0% { stroke-dashoffset: 187 } 50% { stroke-dashoffset: 46.75; transform: rotate(135deg) } to { stroke-dashoffset: 187; transform: rotate(450deg) } } .confirm-box-wrapper,.confirm-box-wrapper .mask { position: absolute; top: 0; left: 0; right: 0; bottom: 0 } .confirm-box-wrapper .mask { background: rgba(0,0,0,.6) } .confirm-box-wrapper .confirm-box { position: fixed; top: 50%; left: 50%; width: 267px; background: #fff; transform: translate(-50%,-50%); border-radius: 7px } .confirm-box-wrapper .confirm-box .head { margin: 0 18px; font-size: 18px; text-align: center; line-height: 65px; border-bottom: 1px solid #d9d9d9 } .confirm-box-wrapper .confirm-box .body { padding: 18px; padding-bottom: 0; color: #353535; font-size: 12.5px; max-height: 150px; overflow: auto } .confirm-box-wrapper .confirm-box .foot { display: -ms-flexbox; display: flex; -ms-flex-direction: row; flex-direction: row; padding: 18px } .confirm-box-wrapper .confirm-box .foot .button-cancel { border: 1px solid #d9d9d9 } .hljs { display: block; overflow-x: auto; padding: .5em; color: #333; background: #f8f8f8 } .hljs-comment,.hljs-quote { color: #998; font-style: italic } .hljs-keyword,.hljs-selector-tag,.hljs-subst { color: #333; font-weight: 700 } .hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable { color: teal } .hljs-doctag,.hljs-string { color: #d14 } .hljs-section,.hljs-selector-id,.hljs-title { color: #900; font-weight: 700 } .hljs-subst { font-weight: 400 } .hljs-class .hljs-title,.hljs-type { color: #458; font-weight: 700 } .hljs-attribute,.hljs-name,.hljs-tag { color: navy; font-weight: 400 } .hljs-link,.hljs-regexp { color: #009926 } .hljs-bullet,.hljs-symbol { color: #990073 } .hljs-built_in,.hljs-builtin-name { color: #0086b3 } .hljs-meta { color: #999; font-weight: 700 } .hljs-deletion { background: #fdd } .hljs-addition { background: #dfd } .hljs-emphasis { font-style: italic } .hljs-strong { font-weight: 700 } .button-cancel[data-v-87ffcada] { color: #888; border: 1px solid #888; border-radius: 3px; margin-right: 12px } .button-cancel[data-v-87ffcada],.button-primary[data-v-87ffcada] { -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1; height: 35px; display: inline-block; font-size: 15px; text-align: center; line-height: 36px } .button-primary[data-v-87ffcada] { color: #fff; background-color: #ff5a05; border-radius: 3px } .pd[data-v-87ffcada] { padding-left: 1.375rem; padding-right: 1.375rem } .article[data-v-87ffcada] { max-width: 70rem; margin: 0 auto } .article .article-unavailable[data-v-87ffcada] { color: #fa8919; font-size: 15px; font-weight: 600; line-height: 24px; border-radius: 5px; padding: 12px; background-color: #f6f7fb; margin-top: 20px } .article .article-unavailable .iconfont[data-v-87ffcada] { font-size: 12px } .article .main[data-v-87ffcada] { padding: 1.25rem 0; margin-bottom: 52px } .article-title[data-v-87ffcada] { color: #353535; font-weight: bold; line-height: 1.65rem; font-size: 1.34375rem } .article-info[data-v-87ffcada] { color: #888; font-size: .9375rem; margin-top: 1.0625rem } .article-content[data-v-87ffcada] { margin-top: 1.0625rem } .article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button { display: none } .copyright[data-v-87ffcada] { color: #b2b2b2; padding-bottom: 20px; margin-top: 20px; font-size: 13px } .audio-player[data-v-87ffcada] { width: 100%; margin: 20px 0 } .to-comment[data-v-87ffcada] { overflow: hidden; padding-top: 10px; margin-bottom: -30px } .to-comment a.button-primary[data-v-87ffcada] { float: right; height: 20px; font-size: 12px; line-height: 20px; padding: 4px 8px; cursor: pointer } .article-comments[data-v-87ffcada] { margin-top: 2rem } .article-comments h2[data-v-87ffcada] { text-align: center; color: #888; position: relative; z-index: 1; margin-bottom: 1rem } .article-comments h2[data-v-87ffcada]:before { border-top: 1px dotted #888; content: ""; position: absolute; top: 56%; left: 0; width: 100%; z-index: -1 } .article-comments h2 span[data-v-87ffcada] { font-size: 15.25px; font-weight: 400; padding: 0 1rem; background: #fff; display: inline-block } .article-sub-bottom[data-v-87ffcada] { z-index: 10; cursor: pointer } .switch-btns[data-v-87ffcada] { height: 76px; cursor: pointer; padding-top: 24px; padding-bottom: 24px; border-bottom: 10px solid #f6f7fb; position: relative } .switch-btns[data-v-87ffcada]:before { content: " "; height: 1px; background: #e8e8e8; position: absolute; top: 0; left: 0; -webkit-box-sizing: border-box; box-sizing: border-box; left: 1.375rem; right: 1.375rem } .switch-btns .btn[data-v-87ffcada] { height: 38px; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .switch-btns .btn .tag[data-v-87ffcada] { -webkit-box-flex: 0; -ms-flex: 0 0 62px; flex: 0 0 62px; text-align: center; color: #888; font-size: 14px; border-radius: 10px; height: 22px; line-height: 22px; background: #f6f7fb; font-weight: 400 } .switch-btns .btn .txt[data-v-87ffcada] { margin-left: 10px; -webkit-box-flex: 1; -ms-flex: 1 1 auto; flex: 1 1 auto; color: #888; font-size: 15px; height: 22px; line-height: 22px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 400 } @media (max-width: 769px) { .article .breadcrumb[data-v-87ffcada] { padding-top:10px; padding-bottom: 10px } } .comment-item { list-style-position: inside; width: 100%; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; margin-bottom: 1rem } .comment-item a { border-bottom: none } .comment-item .avatar { width: 2.625rem; height: 2.625rem; -ms-flex-negative: 0; flex-shrink: 0; border-radius: 50% } .comment-item .info { margin-left: .5rem; -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1 } .comment-item .info .hd { width: 100%; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-pack: justify; -ms-flex-pack: justify; justify-content: space-between; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .comment-item .info .hd .username { color: #888; font-size: 15.25px; font-weight: 400; line-height: 1.2 } .comment-item .info .hd .control { display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .comment-item .info .hd .control .btn-share { color: #888; font-size: .75rem; margin-right: 1rem } .comment-item .info .hd .control .btn-praise { display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-align: center; -ms-flex-align: center; align-items: center; font-size: 15.25px; text-decoration: none } .comment-item .info .hd .control .btn-praise i { color: #888; display: inline-block; font-size: .75rem; margin-right: .3rem; margin-top: -.01rem } .comment-item .info .hd .control .btn-praise i.on,.comment-item .info .hd .control .btn-praise span { color: #ff5a05 } .comment-item .info .bd { color: #353535; font-size: 15.25px; font-weight: 400; white-space: normal; word-break: break-all; line-height: 1.6 } .comment-item .info .time { color: #888; font-size: 9px; line-height: 1 } .comment-item .info .reply .reply-hd { font-size: 15.25px } .comment-item .info .reply .reply-hd span { margin-left: -12px; color: #888; font-weight: 400 } .comment-item .info .reply .reply-hd i { color: #ff5a05; font-size: 15.25px } .comment-item .info .reply .reply-content { background: #f6f7fb; padding: 18px; border-radius: 10px; color: #353535; font-size: 15.25px; font-weight: 400; white-space: normal; word-break: break-all } .comment-item .info .reply .reply-time { color: #888; font-size: 9px } </style> </head> <body> <div id="app"> <div data-v-87ffcada="" class="article" id="watermark"> <div data-v-87ffcada="" class="main main-app"> <h1 data-v-87ffcada="" class="article-title pd"> 16 | 浮点数和定点数（下）：深入理解浮点数到底有什么用？ </h1> <hr> <div data-v-87ffcada="" class="article-content typo common-content pd"> <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/72/95/72da15c9c65ded73b94199aac2c77695.jpg"> <div data-v-87ffcada="" id="article-content" class=""> <div class="text"> <p>上一讲，我们讲了用“浮点数”这样的数据形式，来表示一个不能确定大小的数据范围。浮点数可以大到$3.40×10^{38}$，也可以小到$1.17×10^{-38}$这样的数值。同时，我们也发现，其实我们平时写的0.1、0.2并不是精确的数值，只是一个近似值。只有0.5这样，可以表示成$2^{-1}$这种形式的，才是一个精确的浮点数。</p><p>你是不是感到很疑惑，浮点数的近似值究竟是怎么算出来的？浮点数的加法计算又是怎么回事儿？在实践应用中，我们怎么才用好浮点数呢？这一节，我们就一起来看这几个问题。</p><h2>浮点数的二进制转化</h2><p>我们首先来看，十进制的浮点数怎么表示成二进制。</p><p>我们输入一个任意的十进制浮点数，背后都会对应一个二进制表示。比方说，我们输入了一个十进制浮点数9.1。那么按照之前的讲解，在二进制里面，我们应该把它变成一个“<strong>符号位s+指数位e+有效位数f</strong>”的组合。第一步，我们要做的，就是把这个数变成二进制。</p><p>首先，我们把这个数的整数部分，变成一个二进制。这个我们前面讲二进制的时候已经讲过了。这里的9，换算之后就是1001。</p><!-- [[[read_end]]] --><p>接着，我们把对应的小数部分也换算成二进制。小数怎么换成二进制呢？我们先来定义一下，小数的二进制表示是怎么回事。我们拿0.1001这样一个二进制小数来举例说明。和上面的整数相反，我们把小数点后的每一位，都表示对应的2的-N次方。那么0.1001，转化成十进制就是：</p><p>$1×2^{-1}+0×2^{-2}+0×2^{-3}+$<br>
$1×2^{-4}=0.5625$</p><p>和整数的二进制表示采用“除以2，然后看余数”的方式相比，小数部分转换成二进制是用一个相似的反方向操作，就是乘以2，然后看看是否超过1。如果超过1，我们就记下1，并把结果减去1，进一步循环操作。在这里，我们就会看到，0.1其实变成了一个无限循环的二进制小数，0.0<span class="orange">0011</span>0011。这里的“0011”会无限循环下去。</p><p><img src="https://static001.geekbang.org/resource/image/f9/ae/f9213c43f5fa658a2192a68cd26435ae.jpg" alt=""></p><p>然后，我们把整数部分和小数部分拼接在一起，9.1这个十进制数就变成了1001.0<span class="orange">0011</span>0011…这样一个二进制表示。</p><p>上一讲我们讲过，浮点数其实是用二进制的科学计数法来表示的，所以我们可以把小数点左移三位，这个数就变成了：</p><p>$1.0010$<span class="orange">$0011$</span>$0011… × 2^3$</p><p>那这个二进制的科学计数法表示，我们就可以对应到了浮点数的格式里了。这里的符号位s = 0，对应的有效位f=0010<strong>0011</strong>0011…。因为f最长只有23位，那这里“0011”无限循环，最多到23位就截止了。于是，f=0010<strong>0011001100110011</strong> <strong><span class="orange">001</span></strong>。最后的一个“0011”循环中的最后一个“1”会被截断掉。对应的指数为e，代表的应该是3。因为指数位有正又有负，所以指数位在127之前代表负数，之后代表正数，那3其实对应的是加上127的偏移量130，转化成二进制，就是130，对应的就是指数位的二进制，表示出来就是1000<strong>0010</strong>。</p><p><img src="https://static001.geekbang.org/resource/image/9a/27/9ace5a7404d1790b03d07bd1b3cb5a27.jpeg" alt=""></p><p>然后，我们把“s+e+f”拼在一起，就可以得到浮点数9.1的二进制表示了。最终得到的二进制表示就变成了：</p><p>01000<strong>0010</strong> 0010 <strong>0011001100110011</strong> <strong><span class="orange">001</span></strong></p><p>如果我们再把这个浮点数表示换算成十进制， 实际准确的值是9.09999942779541015625。相信你现在应该不会感觉奇怪了。</p><p>我在这里放一个<a href="https://www.h-schmidt.net/FloatConverter/IEEE754.html">链接</a>，这里提供了直接交互式地设置符号位、指数位和有效位数的操作。你可以直观地看到，32位浮点数每一个bit的变化，对应的有效位数、指数会变成什么样子以及最后的十进制的计算结果是怎样的。</p><p>这个也解释了为什么，在上一讲一开始，0.3+0.6=0.899999。因为0.3转化成浮点数之后，和这里的9.1一样，并不是精确的0.3了，0.6和0.9也是一样的，最后的计算会出现精度问题。</p><h2>浮点数的加法和精度损失</h2><p>搞清楚了怎么把一个十进制的数值，转化成IEEE-754标准下的浮点数表示，我们现在来看一看浮点数的加法是怎么进行的。其实原理也很简单，你记住六个字就行了，那就是<strong>先对齐、再计算</strong>。</p><p>两个浮点数的指数位可能是不一样的，所以我们要把两个的指数位，变成一样的，然后只去计算有效位的加法就好了。</p><p>比如0.5，表示成浮点数，对应的指数位是-1，有效位是00…（后面全是0，记住f前默认有一个1）。0.125表示成浮点数，对应的指数位是-3，有效位也还是00…（后面全是0，记住f前默认有一个1）。</p><p>那我们在计算0.5+0.125的浮点数运算的时候，首先要把两个的指数位对齐，也就是把指数位都统一成两个其中较大的-1。对应的有效位1.00…也要对应右移两位，因为f前面有一个默认的1，所以就会变成0.01。然后我们计算两者相加的有效位1.f，就变成了有效位1.01，而指数位是-1，这样就得到了我们想要的加法后的结果。</p><p>实现这样一个加法，也只需要位移。和整数加法类似的半加器和全加器的方法就能够实现，在电路层面，也并没有引入太多新的复杂性。</p><p><img src="https://static001.geekbang.org/resource/image/d7/f0/d7a6e87da9c0d0b874980ca4306a55f0.jpg" alt=""></p><p>同样的，你可以用刚才那个链接来试试看，我们这个加法计算的浮点数的结果是不是正确。</p><p>回到浮点数的加法过程，你会发现，其中指数位较小的数，需要在有效位进行右移，在右移的过程中，最右侧的有效位就被丢弃掉了。这会导致对应的指数位较小的数，在加法发生之前，就<strong>丢失精度</strong>。两个相加数的指数位差的越大，位移的位数越大，可能丢失的精度也就越大。当然，也有可能你的运气非常好，右移丢失的有效位都是0。这种情况下，对应的加法虽然丢失了需要加的数字的精度，但是因为对应的值都是0，实际的加法的数值结果不会有精度损失。</p><p>32位浮点数的有效位长度一共只有23位，如果两个数的指数位差出23位，较小的数右移24位之后，所有的有效位就都丢失了。这也就意味着，虽然浮点数可以表示上到$3.40×10^{38}$，下到$1.17×10^{-38}$这样的数值范围。但是在实际计算的时候，只要两个数，差出$2^{24}$，也就是差不多1600万倍，那这两个数相加之后，结果完全不会变化。</p><p>你可以试一下，我下面用一个简单的Java程序，让一个值为2000万的32位浮点数和1相加，你会发现，+1这个过程因为精度损失，被“完全抛弃”了。</p><pre><code>public class FloatPrecision {
  public static void main(String[] args) {
    float a = 20000000.0f;
    float b = 1.0f;
    float c = a + b;
    System.out.println(&quot;c is &quot; + c);
    float d = c - a;
    System.out.println(&quot;d is &quot; + d);
  }
}
</code></pre><p>对应的输出结果就是：</p><pre><code>c is 2.0E7
d is 0.0
</code></pre><h2>Kahan Summation算法</h2><p>那么，我们有没有什么办法来解决这个精度丢失问题呢？虽然我们在计算浮点数的时候，常常可以容忍一定的精度损失，但是像上面那样，如果我们连续加2000万个1，2000万的数值都会被精度损失丢掉了，就会影响我们的计算结果。</p><p>一个常见的应用场景是，在一些“积少成多”的计算过程中，比如在机器学习中，我们经常要计算海量样本计算出来的梯度或者loss，于是会出现几亿个浮点数的相加。每个浮点数可能都差不多大，但是随着累积值的越来越大，就会出现“大数吃小数”的情况。</p><p>我们可以做一个简单的实验，用一个循环相加2000万个1.0f，最终的结果会是1600万左右，而不是2000万。这是因为，加到1600万之后的加法因为精度丢失都没有了。这个代码比起上面的使用2000万来加1.0更具有现实意义。</p><pre><code>public class FloatPrecision {
  public static void main(String[] args) {
    float sum = 0.0f;
    for (int i = 0; i &lt; 20000000; i++) {
    	float x = 1.0f;
    	sum += x;    	
    }
    System.out.println(&quot;sum is &quot; + sum);   
  }	
}
</code></pre><p>对应的输出结果是：</p><pre><code>sum is 1.6777216E7
</code></pre><p>面对这个问题，聪明的计算机科学家们也想出了具体的解决办法。他们发明了一种叫作<a href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm">Kahan Summation</a>的算法来解决这个问题。算法的对应代码我也放在文稿中了。从中你可以看到，同样是2000万个1.0f相加，用这种算法我们得到了准确的2000万的结果。</p><pre><code>public class KahanSummation {
  public static void main(String[] args) {
    float sum = 0.0f;
    float c = 0.0f;
    for (int i = 0; i &lt; 20000000; i++) {
    	float x = 1.0f;
    	float y = x - c;
    	float t = sum + y;
    	c = (t-sum)-y;
    	sum = t;    	
    }
    System.out.println(&quot;sum is &quot; + sum);   
  }	
}
</code></pre><p>对应的输出结果就是：</p><pre><code>sum is 2.0E7
</code></pre><p>其实这个算法的原理其实并不复杂，就是在每次的计算过程中，都用一次减法，把当前加法计算中损失的精度记录下来，然后在后面的循环中，把这个精度损失放在要加的小数上，再做一次运算。</p><p>如果你对这个背后的数学原理特别感兴趣，可以去看一看<a href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm">Wikipedia链接</a>里面对应的数学证明，也可以生成一些数据试一试这个算法。这个方法在实际的数值计算中也是常用的，也是大量数据累加中，解决浮点数精度带来的“大数吃小数”问题的必备方案。</p><h2>总结延伸</h2><p>到这里，我们已经讲完了浮点数的表示、加法计算以及可能会遇到的精度损失问题。可以看到，虽然浮点数能够表示的数据范围变大了很多，但是在实际应用的时候，由于存在精度损失，会导致加法的结果和我们的预期不同，乃至于完全没有加上的情况。</p><p>所以，一般情况下，在实践应用中，对于需要精确数值的，比如银行存款、电商交易，我们都会使用定点数或者整数类型。</p><p>比方说，你一定在MySQL里用过decimal(12,2)，来表示订单金额。如果我们的银行存款用32位浮点数表示，就会出现，马云的账户里有2千万，我的账户里只剩1块钱。结果银行一汇总总金额，那1块钱在账上就“不翼而飞”了。</p><p>而浮点数呢，则更适合我们不需要有一个非常精确的计算结果的情况。因为在真实的物理世界里，很多数值本来就不是精确的，我们只需要有限范围内的精度就好了。比如，从我家到办公室的距离，就不存在一个100%精确的值。我们可以精确到公里、米，甚至厘米，但是既没有必要、也没有可能去精确到微米乃至纳米。</p><p>对于浮点数加法中可能存在的精度损失，特别是大量加法运算中累积产生的巨大精度损失，我们可以用Kahan Summation这样的软件层面的算法来解决。</p><p>好了，到了这里，我已经把浮点数讲透了。希望你能从数据的表示、加法的实现，乃至实践应用、数值算法层面能够体会到，搞清楚一个计算机问题的基本原理，其实能够帮助你理解它的实践应用，乃至找到在特定问题下的可行解决方案。接下来，我们要深入到CPU的构造，去理解计算机组成原理。</p><h2>推荐阅读</h2><p>浮点数的加法我们讲完了。想要更深入地了解乘法乃至除法，可以参看《计算机组成与设计 硬件/软件接口》的3.5.2和3.5.3小节。</p><h2>课后思考</h2><p>这两节我讲的都是32位浮点数，那么对于64位浮点数的加法，两个数相差多少的情况后，较小的哪个数在加法过程中会完全丢失呢？</p><p>欢迎你在留言区写下你的思考和疑问，和大家一起探讨。你也可以把今天的文章分享给你朋友，和他一起学习和进步。</p><p><img src="https://static001.geekbang.org/resource/image/28/29/281ca28b90c8aa0aecbb5adc08394f29.jpg" alt=""></p> </div> </div> <div data-v-87ffcada="" class="article-comments"><h2 data-v-87ffcada=""><span data-v-87ffcada="">精选留言</span></h2> <ul data-v-87ffcada="">  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">有米</span> </div> <div class="bd">decimal是如何实现保证不丢精度呢？<br></div> <span class="time">2019-05-30</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/67/01/a5bb9c92.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">初心丶可曾記</span> </div> <div class="bd">64位浮点数，有效位是52位,所以相差2^53会丢失较小的数<br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">humor</span> </div> <div class="bd">对于64位的符点数，符号位是52位，所以应该是如果两个相差2^53倍及以上的数相加，较小的数会完全丢失吧。<br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="" class="avatar"> <div class="info"> <div class="hd"><span class="username">senekis</span> </div> <div class="bd">老师，我使用了IEEE754的网站，输入浮点数9.1，得到结果:<br>010000010 0010 0011001100110011 010<br>而按照老师的算法, 得到的结果是：<br>010000010 0010 0011001100110011 001<br>差了一位，这是为什么呢？是使用方法不正确吗？<br>推算了N次也没有对上，求老师给答个疑～！谢谢老师！<br></div> <span class="time">2019-06-01</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/13/9d/d91dc762.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">喜欢吃鱼</span> </div> <div class="bd">老师，您能解释下Kahan算法for循环中y,c着两个变量的意思吗？<br>我想的是t用来保存累加和，c用来保存此次累加过程中被损失的精度，但是y=x-c这里不太了解，望老师解答一下。<br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="" class="avatar"> <div class="info"> <div class="hd"><span class="username">有铭</span> </div> <div class="bd">decimal难道就是所谓定点数？Java里的BigDecimal的原理是什么？<br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/85/bf/5c5e86bb.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">龙猫</span> </div> <div class="bd">Kahan Summation<br><br>sum = 0.0<br>c = 0.0<br>for ------------------<br>    y = x - c<br>    t = s + y<br>    c = (t - s) - y<br>    s = t <br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/78/ac/e5e6e7f3.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">古夜</span> </div> <div class="bd">这两章得反复看<br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/IPdZZXuHVMibwfZWmm7NiawzeEFGsaRoWjhuN99iaoj5amcRkiaOePo6rH1KJ3jictmNlic4OibkF4I20vOGfwDqcBxfA/132" class="avatar"> <div class="info"> <div class="hd"><span class="username">鱼向北游</span> </div> <div class="bd">double按规范是符号位1位 阶码11位 尾码52位 精度差2的53次方就会有问题了<br>long double就和各平台差异相关了<br></div> <span class="time">2019-05-31</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Linuxer</span> </div> <div class="bd">请教64位的浮点数还是一位符号为，8位指数吗？另外浮点数减法是转换成加法进行运算吗？那符号位怎么处理?<br></div> <span class="time">2019-05-31</span>  </div> </li>  </ul> </div> </div> </div> </div> </div> </body> </html>
