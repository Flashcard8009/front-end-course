<html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"> <meta name="format-detection" content="telephone=no"> <title>09 | 程序装载：“640K内存”真的不够用么？</title>         <style type="text/css"> html { color: #333; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; text-rendering: optimizelegibility; font-family: Helvetica Neue,PingFang SC,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif } html.borderbox *,html.borderbox :after,html.borderbox :before { box-sizing: border-box } article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul { margin: 0; padding: 0 } article,aside,details,figcaption,figure,footer,header,menu,nav,section { display: block } audio,canvas,video { display: inline-block } body,button,input,select,textarea { font: 300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif } button::-moz-focus-inner,input::-moz-focus-inner { padding: 0; border: 0 } table { border-collapse: collapse; border-spacing: 0 } fieldset,img { border: 0 } blockquote { position: relative; color: #999; font-weight: 400; border-left: 1px solid #1abc9c; padding-left: 1em; margin: 1em 3em 1em 2em } @media only screen and (max-width: 640px) { blockquote { margin:1em 0 } } abbr,acronym { border-bottom: 1px dotted; font-variant: normal } abbr { cursor: help } del { text-decoration: line-through } address,caption,cite,code,dfn,em,th,var { font-style: normal; font-weight: 400 } ol,ul { list-style: none } caption,th { text-align: left } q:after,q:before { content: "" } sub,sup { font-size: 75%; line-height: 0; position: relative } :root sub,:root sup { vertical-align: baseline } sup { top: -.5em } sub { bottom: -.25em } a { color: #1abc9c } a:hover { text-decoration: underline } .typo a { border-bottom: 1px solid #1abc9c } .typo a:hover { border-bottom-color: #555; color: #555 } .typo a:hover,a,ins { text-decoration: none } .typo-u,u { text-decoration: underline } mark { background: #fffdd1; border-bottom: 1px solid #ffedce; padding: 2px; margin: 0 5px } code,pre,pre tt { font-family: Courier,Courier New,monospace } pre { background: hsla(0,0%,97%,.7); border: 1px solid #ddd; padding: 1em 1.5em; display: block; -webkit-overflow-scrolling: touch } hr { border: none; border-bottom: 1px solid #cfcfcf; margin-bottom: .8em; height: 10px } .typo-small,figcaption,small { font-size: .9em; color: #888 } b,strong { font-weight: 700; color: #000 } [draggable] { cursor: move } .clearfix:after,.clearfix:before { content: ""; display: table } .clearfix:after { clear: both } .clearfix { zoom:1} .textwrap,.textwrap td,.textwrap th { word-wrap: break-word; word-break: break-all } .textwrap-table { table-layout: fixed } .serif { font-family: Palatino,Optima,Georgia,serif } .typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote { margin-bottom: 1rem } h1,h2,h3,h4,h5,h6 { font-family: PingFang SC,Helvetica Neue,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif; color: #000; line-height: 1.35 } .typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6 { margin-top: 1.2em; margin-bottom: .6em; line-height: 1.35 } .typo-h1,.typo h1 { font-size: 2em } .typo-h2,.typo h2 { font-size: 1.8em } .typo-h3,.typo h3 { font-size: 1.6em } .typo-h4,.typo h4 { font-size: 1.4em } .typo-h5,.typo-h6,.typo h5,.typo h6 { font-size: 1.2em } .typo-ul,.typo ul { margin-left: 1.3em; list-style: disc } .typo-ol,.typo ol { list-style: decimal; margin-left: 1.9em } .typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul { margin-bottom: .8em; margin-left: 2em } .typo-ol ul,.typo-ul ul,.typo li ul { list-style: circle } .typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th { border: 1px solid #ddd; padding: .5em 1em; color: #666 } .typo-table th,.typo table th { background: #fbfbfb } .typo-table thead th,.typo table thead th { background: hsla(0,0%,95%,.7) } .typo table caption { border-bottom: none } .typo-input,.typo-textarea { -webkit-appearance: none; border-radius: 0 } .typo-em,.typo em,caption,legend { color: #000; font-weight: inherit } .typo-em { position: relative } .typo-em:after { position: absolute; top: .65em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB" } .typo img { max-width: 100% } .common-content { font-weight: 400; color: #353535; line-height: 1.75rem; white-space: normal; word-break: normal; font-size: 1rem } .common-content img { display: block; max-width: 100%; background-color: #eee } .common-content audio,.common-content video { width: 100%; background-color: #eee } .common-content center,.common-content font { margin-top: 1rem; display: inline-block } .common-content center { width: 100% } .common-content pre { margin-top: 1rem; padding-left: 0; padding-right: 0; position: relative; overflow: hidden } .common-content pre code { font-size: .8rem; font-family: Consolas,Liberation Mono,Menlo,monospace,Courier; display: block; width: 100%; box-sizing: border-box; padding-left: 1rem; padding-right: 1rem; overflow-x: auto } .common-content hr { border: none; margin-top: 1.5rem; margin-bottom: 1.5rem; border-top: 1px solid #f5f5f5; height: 1px; background: none } .common-content b,.common-content h1,.common-content h2,.common-content h3,.common-content h4,.common-content h5,.common-content strong { font-weight: 700 } .common-content h1,.common-content h2 { font-size: 1.125rem; margin-bottom: .45rem } .common-content h3,.common-content h4,.common-content h5 { font-size: 1rem; margin-bottom: .45rem } .common-content p { font-weight: 400; color: #353535; margin-top: .15rem } .common-content .orange { color: #ff5a05 } .common-content .reference { font-size: 1rem; color: #888 } .custom-rich-content h1 { margin-top: 0; font-weight: 400; font-size: 15.25px; border-bottom: 1px solid #eee; line-height: 2.8 } .custom-rich-content li,.custom-rich-content p { font-size: 14px; color: #888; line-height: 1.6 } table.hljs-ln { margin-bottom: 0; border-spacing: 0; border-collapse: collapse } table.hljs-ln,table.hljs-ln tbody,table.hljs-ln td,table.hljs-ln tr { box-sizing: border-box } table.hljs-ln td { padding: 0; border: 0 } table.hljs-ln td.hljs-ln-numbers { min-width: 15px; color: rgba(27,31,35,.3); text-align: right; white-space: nowrap; cursor: pointer; user-select: none } table.hljs-ln td.hljs-ln-code,table.hljs-ln td.hljs-ln-numbers { font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace; font-size: 12px; line-height: 20px; vertical-align: top } table.hljs-ln td.hljs-ln-code { position: relative; padding-right: 10px; padding-left: 10px; overflow: visible; color: #24292e; word-wrap: normal; white-space: pre } video::-webkit-media-controls { overflow: hidden!important } video::-webkit-media-controls-enclosure { width: calc(100% + 32px); margin-left: auto } .button-cancel { color: #888; border: 1px solid #888; border-radius: 3px; margin-right: 12px } .button-cancel,.button-primary { -ms-flex-positive: 1; flex-grow: 1; height: 35px; display: inline-block; font-size: 15px; text-align: center; line-height: 36px } .button-primary { color: #fff; background-color: #ff5a05; border-radius: 3px } @font-face { font-family: iconfont; src: url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot); src: url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.woff) format("woff"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.ttf) format("truetype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.svg#iconfont) format("svg") } @font-face { font-family: player-font; src: url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot); src: url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.woff) format("woff"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.ttf) format("truetype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.svg#player-font) format("svg") } .iconfont { font-family: iconfont!important; font-size: 16px; font-style: normal; -webkit-font-smoothing: antialiased; -webkit-text-stroke-width: .2px; -moz-osx-font-smoothing: grayscale } html { background: #fff; min-height: 100%; -webkit-tap-highlight-color: rgba(0,0,0,0) } body { width: 100% } body.fixed { overflow: hidden; position: fixed; width: 100vw; height: 100vh } i { font-style: normal } a { word-wrap: break-word; -webkit-tap-highlight-color: rgba(0,0,0,0) } a:hover { text-decoration: none } .fade-enter-active,.fade-leave-active { transition: opacity .3s } .fade-enter,.fade-leave-to { opacity: 0 } .MathJax,.MathJax_CHTML,.MathJax_MathContainer,.MathJax_MathML,.MathJax_PHTML,.MathJax_PlainSource,.MathJax_SVG { outline: 0 } .ios-app-switch .js-audit { display: none } ._loading_wrap_ { position: fixed; width: 100vw; height: 100vh; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 999 } ._loading_div_class_,._loading_wrap_ { display: -ms-flexbox; display: flex; -ms-flex-pack: center; justify-content: center; -ms-flex-align: center; align-items: center } ._loading_div_class_ { word-wrap: break-word; padding: .5rem .75rem; text-align: center; z-index: 9999; font-size: .6rem; max-width: 60%; color: #fff; border-radius: .25rem; -ms-flex-direction: column; flex-direction: column } ._loading_div_class_ .message { color: #353535; font-size: 16px; line-height: 3 } .spinner { animation: circle-rotator 1.4s linear infinite } .spinner * { line-height: 0; box-sizing: border-box } @keyframes circle-rotator { 0% { transform: rotate(0deg) } to { transform: rotate(270deg) } } .path { stroke-dasharray: 187; stroke-dashoffset: 0; transform-origin: center; animation: circle-dash 1.4s ease-in-out infinite,circle-colors 5.6s ease-in-out infinite } @keyframes circle-colors { 0% { stroke: #ff5a05 } to { stroke: #ff5a05 } } @keyframes circle-dash { 0% { stroke-dashoffset: 187 } 50% { stroke-dashoffset: 46.75; transform: rotate(135deg) } to { stroke-dashoffset: 187; transform: rotate(450deg) } } .confirm-box-wrapper,.confirm-box-wrapper .mask { position: absolute; top: 0; left: 0; right: 0; bottom: 0 } .confirm-box-wrapper .mask { background: rgba(0,0,0,.6) } .confirm-box-wrapper .confirm-box { position: fixed; top: 50%; left: 50%; width: 267px; background: #fff; transform: translate(-50%,-50%); border-radius: 7px } .confirm-box-wrapper .confirm-box .head { margin: 0 18px; font-size: 18px; text-align: center; line-height: 65px; border-bottom: 1px solid #d9d9d9 } .confirm-box-wrapper .confirm-box .body { padding: 18px; padding-bottom: 0; color: #353535; font-size: 12.5px; max-height: 150px; overflow: auto } .confirm-box-wrapper .confirm-box .foot { display: -ms-flexbox; display: flex; -ms-flex-direction: row; flex-direction: row; padding: 18px } .confirm-box-wrapper .confirm-box .foot .button-cancel { border: 1px solid #d9d9d9 } .hljs { display: block; overflow-x: auto; padding: .5em; color: #333; background: #f8f8f8 } .hljs-comment,.hljs-quote { color: #998; font-style: italic } .hljs-keyword,.hljs-selector-tag,.hljs-subst { color: #333; font-weight: 700 } .hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable { color: teal } .hljs-doctag,.hljs-string { color: #d14 } .hljs-section,.hljs-selector-id,.hljs-title { color: #900; font-weight: 700 } .hljs-subst { font-weight: 400 } .hljs-class .hljs-title,.hljs-type { color: #458; font-weight: 700 } .hljs-attribute,.hljs-name,.hljs-tag { color: navy; font-weight: 400 } .hljs-link,.hljs-regexp { color: #009926 } .hljs-bullet,.hljs-symbol { color: #990073 } .hljs-built_in,.hljs-builtin-name { color: #0086b3 } .hljs-meta { color: #999; font-weight: 700 } .hljs-deletion { background: #fdd } .hljs-addition { background: #dfd } .hljs-emphasis { font-style: italic } .hljs-strong { font-weight: 700 } .button-cancel[data-v-87ffcada] { color: #888; border: 1px solid #888; border-radius: 3px; margin-right: 12px } .button-cancel[data-v-87ffcada],.button-primary[data-v-87ffcada] { -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1; height: 35px; display: inline-block; font-size: 15px; text-align: center; line-height: 36px } .button-primary[data-v-87ffcada] { color: #fff; background-color: #ff5a05; border-radius: 3px } .pd[data-v-87ffcada] { padding-left: 1.375rem; padding-right: 1.375rem } .article[data-v-87ffcada] { max-width: 70rem; margin: 0 auto } .article .article-unavailable[data-v-87ffcada] { color: #fa8919; font-size: 15px; font-weight: 600; line-height: 24px; border-radius: 5px; padding: 12px; background-color: #f6f7fb; margin-top: 20px } .article .article-unavailable .iconfont[data-v-87ffcada] { font-size: 12px } .article .main[data-v-87ffcada] { padding: 1.25rem 0; margin-bottom: 52px } .article-title[data-v-87ffcada] { color: #353535; font-weight: bold; line-height: 1.65rem; font-size: 1.34375rem } .article-info[data-v-87ffcada] { color: #888; font-size: .9375rem; margin-top: 1.0625rem } .article-content[data-v-87ffcada] { margin-top: 1.0625rem } .article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button { display: none } .copyright[data-v-87ffcada] { color: #b2b2b2; padding-bottom: 20px; margin-top: 20px; font-size: 13px } .audio-player[data-v-87ffcada] { width: 100%; margin: 20px 0 } .to-comment[data-v-87ffcada] { overflow: hidden; padding-top: 10px; margin-bottom: -30px } .to-comment a.button-primary[data-v-87ffcada] { float: right; height: 20px; font-size: 12px; line-height: 20px; padding: 4px 8px; cursor: pointer } .article-comments[data-v-87ffcada] { margin-top: 2rem } .article-comments h2[data-v-87ffcada] { text-align: center; color: #888; position: relative; z-index: 1; margin-bottom: 1rem } .article-comments h2[data-v-87ffcada]:before { border-top: 1px dotted #888; content: ""; position: absolute; top: 56%; left: 0; width: 100%; z-index: -1 } .article-comments h2 span[data-v-87ffcada] { font-size: 15.25px; font-weight: 400; padding: 0 1rem; background: #fff; display: inline-block } .article-sub-bottom[data-v-87ffcada] { z-index: 10; cursor: pointer } .switch-btns[data-v-87ffcada] { height: 76px; cursor: pointer; padding-top: 24px; padding-bottom: 24px; border-bottom: 10px solid #f6f7fb; position: relative } .switch-btns[data-v-87ffcada]:before { content: " "; height: 1px; background: #e8e8e8; position: absolute; top: 0; left: 0; -webkit-box-sizing: border-box; box-sizing: border-box; left: 1.375rem; right: 1.375rem } .switch-btns .btn[data-v-87ffcada] { height: 38px; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .switch-btns .btn .tag[data-v-87ffcada] { -webkit-box-flex: 0; -ms-flex: 0 0 62px; flex: 0 0 62px; text-align: center; color: #888; font-size: 14px; border-radius: 10px; height: 22px; line-height: 22px; background: #f6f7fb; font-weight: 400 } .switch-btns .btn .txt[data-v-87ffcada] { margin-left: 10px; -webkit-box-flex: 1; -ms-flex: 1 1 auto; flex: 1 1 auto; color: #888; font-size: 15px; height: 22px; line-height: 22px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 400 } @media (max-width: 769px) { .article .breadcrumb[data-v-87ffcada] { padding-top:10px; padding-bottom: 10px } } .comment-item { list-style-position: inside; width: 100%; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; margin-bottom: 1rem } .comment-item a { border-bottom: none } .comment-item .avatar { width: 2.625rem; height: 2.625rem; -ms-flex-negative: 0; flex-shrink: 0; border-radius: 50% } .comment-item .info { margin-left: .5rem; -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1 } .comment-item .info .hd { width: 100%; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-pack: justify; -ms-flex-pack: justify; justify-content: space-between; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .comment-item .info .hd .username { color: #888; font-size: 15.25px; font-weight: 400; line-height: 1.2 } .comment-item .info .hd .control { display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .comment-item .info .hd .control .btn-share { color: #888; font-size: .75rem; margin-right: 1rem } .comment-item .info .hd .control .btn-praise { display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-align: center; -ms-flex-align: center; align-items: center; font-size: 15.25px; text-decoration: none } .comment-item .info .hd .control .btn-praise i { color: #888; display: inline-block; font-size: .75rem; margin-right: .3rem; margin-top: -.01rem } .comment-item .info .hd .control .btn-praise i.on,.comment-item .info .hd .control .btn-praise span { color: #ff5a05 } .comment-item .info .bd { color: #353535; font-size: 15.25px; font-weight: 400; white-space: normal; word-break: break-all; line-height: 1.6 } .comment-item .info .time { color: #888; font-size: 9px; line-height: 1 } .comment-item .info .reply .reply-hd { font-size: 15.25px } .comment-item .info .reply .reply-hd span { margin-left: -12px; color: #888; font-weight: 400 } .comment-item .info .reply .reply-hd i { color: #ff5a05; font-size: 15.25px } .comment-item .info .reply .reply-content { background: #f6f7fb; padding: 18px; border-radius: 10px; color: #353535; font-size: 15.25px; font-weight: 400; white-space: normal; word-break: break-all } .comment-item .info .reply .reply-time { color: #888; font-size: 9px } </style> </head> <body> <div id="app"> <div data-v-87ffcada="" class="article" id="watermark"> <div data-v-87ffcada="" class="main main-app"> <h1 data-v-87ffcada="" class="article-title pd"> 09 | 程序装载：“640K内存”真的不够用么？ </h1> <hr> <div data-v-87ffcada="" class="article-content typo common-content pd"> <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/7c/52/7c6d9542bbf4cb1a1791dadd589a7952.jpg"> <div data-v-87ffcada="" id="article-content" class=""> <div class="text"> <p>计算机这个行业的历史上有过很多成功的预言，最著名的自然是“摩尔定律”。当然免不了的也有很多“失败”的预测，其中一个最著名的就是，比尔·盖茨在上世纪80年代说的“640K ought to be enough for anyone”，也就是“640K内存对哪个人来说都够用了”。</p><p>那个年代，微软开发的还是DOS操作系统，程序员们还在绞尽脑汁，想要用好这极为有限的640K内存。而现在，我手头的开发机已经是16G内存了，上升了一万倍还不止。那比尔·盖茨这句话在当时也是完全的无稽之谈么？有没有哪怕一点点的道理呢？这一讲里，我就和你一起来看一看。</p><h2>程序装载面临的挑战</h2><p>上一讲，我们看到了如何通过链接器，把多个文件合并成一个最终可执行文件。在运行这些可执行文件的时候，我们其实是通过一个装载器，解析ELF或者PE格式的可执行文件。装载器会把对应的指令和数据加载到内存里面来，让CPU去执行。</p><p>说起来只是装载到内存里面这一句话的事儿，实际上装载器需要满足两个要求。</p><p><strong>第一，可执行程序加载后占用的内存空间应该是连续的</strong>。我们在<a href="https://time.geekbang.org/column/article/94075">第6讲</a>讲过，执行指令的时候，程序计数器是顺序地一条一条指令执行下去。这也就意味着，这一条条指令需要连续地存储在一起。</p><!-- [[[read_end]]] --><p><strong>第二，我们需要同时加载很多个程序，并且不能让程序自己规定在内存中加载的位置。</strong>虽然编译出来的指令里已经有了对应的各种各样的内存地址，但是实际加载的时候，我们其实没有办法确保，这个程序一定加载在哪一段内存地址上。因为我们现在的计算机通常会同时运行很多个程序，可能你想要的内存地址已经被其他加载了的程序占用了。</p><p>要满足这两个基本的要求，我们很容易想到一个办法。那就是我们可以在内存里面，找到一段连续的内存空间，然后分配给装载的程序，然后把这段连续的内存空间地址，和整个程序指令里指定的内存地址做一个映射。</p><p>我们把指令里用到的内存地址叫作<strong>虚拟内存地址</strong>（Virtual Memory Address），实际在内存硬件里面的空间地址，我们叫<strong>物理内存地址</strong>（Physical Memory Address）<strong>。</strong></p><p>程序里有指令和各种内存地址，我们只需要关心虚拟内存地址就行了。对于任何一个程序来说，它看到的都是同样的内存地址。我们维护一个虚拟内存到物理内存的映射表，这样实际程序指令执行的时候，会通过虚拟内存地址，找到对应的物理内存地址，然后执行。因为是连续的内存地址空间，所以我们只需要维护映射关系的起始地址和对应的空间大小就可以了。</p><h2>内存分段</h2><p>这种找出一段连续的物理内存和虚拟内存地址进行映射的方法，我们叫<strong>分段</strong>（Segmentation）<strong>。</strong>这里的段，就是指系统分配出来的那个连续的内存空间。</p><p><img src="https://static001.geekbang.org/resource/image/24/18/24596e1e66d88c5d077b4c957d0d7f18.png" alt=""></p><p>分段的办法很好，解决了程序本身不需要关心具体的物理内存地址的问题，但它也有一些不足之处，第一个就是<strong>内存碎片</strong>（Memory Fragmentation）的问题。</p><p>我们来看这样一个例子。我现在手头的这台电脑，有1GB的内存。我们先启动一个图形渲染程序，占用了512MB的内存，接着启动一个Chrome浏览器，占用了128MB内存，再启动一个Python程序，占用了256MB内存。这个时候，我们关掉Chrome，于是空闲内存还有1024 - 512 - 256 = 256MB。按理来说，我们有足够的空间再去装载一个200MB的程序。但是，这256MB的内存空间不是连续的，而是被分成了两段128MB的内存。因此，实际情况是，我们的程序没办法加载进来。</p><p><img src="https://static001.geekbang.org/resource/image/57/d1/57211af3053ed621aeb903433c6c10d1.png" alt=""></p><p>当然，这个我们也有办法解决。解决的办法叫<strong>内存交换</strong>（Memory Swapping）。</p><p>我们可以把Python程序占用的那256MB内存写到硬盘上，然后再从硬盘上读回来到内存里面。不过读回来的时候，我们不再把它加载到原来的位置，而是紧紧跟在那已经被占用了的512MB内存后面。这样，我们就有了连续的256MB内存空间，就可以去加载一个新的200MB的程序。如果你自己安装过Linux操作系统，你应该遇到过分配一个swap硬盘分区的问题。这块分出来的磁盘空间，其实就是专门给Linux操作系统进行内存交换用的。</p><p>虚拟内存、分段，再加上内存交换，看起来似乎已经解决了计算机同时装载运行很多个程序的问题。不过，你千万不要大意，这三者的组合仍然会遇到一个性能瓶颈。硬盘的访问速度要比内存慢很多，而每一次内存交换，我们都需要把一大段连续的内存数据写到硬盘上。所以，如果内存交换的时候，交换的是一个很占内存空间的程序，这样整个机器都会显得卡顿。</p><h2>内存分页</h2><p>既然问题出在内存碎片和内存交换的空间太大上，那么解决问题的办法就是，少出现一些内存碎片。另外，当需要进行内存交换的时候，让需要交换写入或者从磁盘装载的数据更少一点，这样就可以解决这个问题。这个办法，在现在计算机的内存管理里面，就叫作<strong>内存分页</strong>（Paging）。</p><p><strong>和分段这样分配一整段连续的空间给到程序相比，分页是把整个物理内存空间切成一段段固定尺寸的大小</strong>。而对应的程序所需要占用的虚拟内存空间，也会同样切成一段段固定尺寸的大小。这样一个连续并且尺寸固定的内存空间，我们叫<strong>页</strong>（Page）。从虚拟内存到物理内存的映射，不再是拿整段连续的内存的物理地址，而是按照一个一个页来的。页的尺寸一般远远小于整个程序的大小。在Linux下，我们通常只设置成4KB。你可以通过命令看看你手头的Linux系统设置的页的大小。</p><pre><code>$ getconf PAGE_SIZE
</code></pre><p>由于内存空间都是预先划分好的，也就没有了不能使用的碎片，而只有被释放出来的很多4KB的页。即使内存空间不够，需要让现有的、正在运行的其他程序，通过内存交换释放出一些内存的页出来，一次性写入磁盘的也只有少数的一个页或者几个页，不会花太多时间，让整个机器被内存交换的过程给卡住。</p><p><img src="https://static001.geekbang.org/resource/image/0c/f0/0cf2f08e1ceda473df71189334857cf0.png" alt=""></p><p>更进一步地，分页的方式使得我们在加载程序的时候，不再需要一次性都把程序加载到物理内存中。我们完全可以在进行虚拟内存和物理内存的页之间的映射之后，并不真的把页加载到物理内存里，而是只在程序运行中，需要用到对应虚拟内存页里面的指令和数据时，再加载到物理内存里面去。</p><p>实际上，我们的操作系统，的确是这么做的。当要读取特定的页，却发现数据并没有加载到物理内存里的时候，就会触发一个来自于CPU的<strong>缺页错误</strong>（Page Fault）。我们的操作系统会捕捉到这个错误，然后将对应的页，从存放在硬盘上的虚拟内存里读取出来，加载到物理内存里。这种方式，使得我们可以运行那些远大于我们实际物理内存的程序。同时，这样一来，任何程序都不需要一次性加载完所有指令和数据，只需要加载当前需要用到就行了。</p><p>通过虚拟内存、内存交换和内存分页这三个技术的组合，我们最终得到了一个让程序不需要考虑实际的物理内存地址、大小和当前分配空间的解决方案。这些技术和方法，对于我们程序的编写、编译和链接过程都是透明的。这也是我们在计算机的软硬件开发中常用的一种方法，就是<strong>加入一个间接层</strong>。</p><p>通过引入虚拟内存、页映射和内存交换，我们的程序本身，就不再需要考虑对应的真实的内存地址、程序加载、内存管理等问题了。任何一个程序，都只需要把内存当成是一块完整而连续的空间来直接使用。</p><h2>总结延伸</h2><p>现在回到开头我问你的问题，我们的电脑只要640K内存就够了吗？很显然，现在来看，比尔·盖茨的这个判断是不合理的，那为什么他会这么认为呢？因为他也是一个很优秀的程序员啊！</p><p>在虚拟内存、内存交换和内存分页这三者结合之下，你会发现，其实要运行一个程序，“必需”的内存是很少的。CPU只需要执行当前的指令，极限情况下，内存也只需要加载一页就好了。再大的程序，也可以分成一页。每次，只在需要用到对应的数据和指令的时候，从硬盘上交换到内存里面来就好了。以我们现在4K内存一页的大小，640K内存也能放下足足160页呢，也无怪乎在比尔·盖茨会说出“640K ought to be enough for anyone”这样的话。</p><p>不过呢，硬盘的访问速度比内存慢很多，所以我们现在的计算机，没有个几G的内存都不好意思和人打招呼。</p><p>那么，除了程序分页装载这种方式之外，我们还有其他优化内存使用的方式么？下一讲，我们就一起来看看“动态装载”，学习一下让两个不同的应用程序，共用一个共享程序库的办法。</p><h2>推荐阅读</h2><p>想要更深入地了解代码装载的详细过程，推荐你阅读《程序员的自我修养——链接、装载和库》的第1章和第6章。</p><h2>课后思考</h2><p>请你想一想，在Java这样使用虚拟机的编程语言里面，我们写的程序是怎么装载到内存里面来的呢？它也和我们讲的一样，是通过内存分页和内存交换的方式加载到内存里面来的么？</p><p>欢迎你在留言区写下你的思考和疑问，和大家一起探讨。你也可以把今天的文章分享给你朋友，和他一起学习和进步。</p><p><img src="https://static001.geekbang.org/resource/image/28/29/281ca28b90c8aa0aecbb5adc08394f29.jpg" alt=""></p> </div> </div> <div data-v-87ffcada="" class="article-comments"><h2 data-v-87ffcada=""><span data-v-87ffcada="">精选留言</span></h2> <ul data-v-87ffcada="">  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/16/ee/9e/204ce89c.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">徐</span> </div> <div class="bd">请教一下，按页分配就不需要连续内存空间了吗？进而，既然不需要连续，为什么还要再交换，不是随便放就好了吗？<br></div> <span class="time">2019-05-16</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">一页之内要连续,不同的页之间不需要。随便放内存里也放不下啊</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">humor</span> </div> <div class="bd">既然操作系统本身有虚拟内存、内存交换和内存分页的能力，JVM为什么还要自己配置Heap等的大小呢？如果内存使用大于JVM配置的值，还会报OOM，反正有swap空间，让操作系统自己去做内存交换不就可以了吗？<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">JVM并不是一个系统级的程序啊，其实只是一个操作系统之上的应用程序，申请的这些heap size是确保自己只使用特定规模的资源啊</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">曾轼麟</span> </div> <div class="bd">jvm已经是上层应用，无需考虑物理分页，一般更直接是考虑对象本身的空间大小，物理硬件管理统一由承载jvm的操纵系统去解决吧<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">👍完全正确</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/b9/74/de434e5f.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">高鑫</span> </div> <div class="bd">老师好，有个问题请教，虚拟内存地址与物理内存地址是n：1的关系吗？<br></div> <span class="time">2019-05-17</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/f5/b9/888fe350.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">不记年</span> </div> <div class="bd">内存分页使得映射的基本单元从段变成了规范的，容易处理的页<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">👍</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/12/93/3470fc43.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Mr.钧👻</span> </div> <div class="bd">想请教下，段，页我知道是什么了，那 “块”又是什么呢？<br></div> <span class="time">2019-05-21</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/df/43/0673450f.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">子杨</span> </div> <div class="bd">我们的操作系统会捕捉到这个错误，然后将对应的页，从存放在硬盘上的虚拟内存里读取出来，加载到物理内存里。这种方式，使得我们可以运行那些远大于我们实际物理内存的程序。同时，这样一来，任何程序都不需要一次性加载完所有指令和数据，只需要加载当前需要用到就行了。<br><br>徐老师，这段话真的很懵，不需要一次性加载，那是存在 swap 分区中吗？这二者是啥关系？<br></div> <span class="time">2019-05-21</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/df/43/0673450f.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">子杨</span> </div> <div class="bd">「我们的操作系统会捕捉到这个错误，然后将对应的页，从存放在硬盘上的虚拟内存里读取出来，加载到物理内存中」<br>这段话不太理解，虚拟内存不是指的程序中的内存地址吗？难道是实际存放在硬盘上的一段空间？那这和 Swap 分区有何关系吗？<br></div> <span class="time">2019-05-21</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">活的潇洒</span> </div> <div class="bd">从第1遍听到语言，到现在的笔记花了不少3个小时的时间，但是收获确实很多<br>刚完成笔记：https:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10894963.html<br><br></div> <span class="time">2019-05-20</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/fd/be/079c78c7.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">焰火</span> </div> <div class="bd">浩哥，请问一下，操作系统本身在运行过程中应该不能采用分页机制吧。这讲的分页机制应该只是针对用户的应用程序之上？ <br>我刚刚查了一下我的window任务管理器上system的进程总大小也就300+MB，操作系统自身所占的内容就这么大么？<br></div> <span class="time">2019-05-20</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/cb/c8/ff9f3ffb.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">赵国辉</span> </div> <div class="bd">虚拟内存和物理内存的页之间的映射，是发生在页载入内存时开始运行程序时？如果是后者，映射的规则是什么？<br></div> <span class="time">2019-05-19</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">一步</span> </div> <div class="bd">老师请教两个问题：<br>1: 在对物理内存和虚拟内存进行分页的时候，依据是什么？物理内存的分页是固定的吗？ 是不是修改了 PAGE_SIZE的大小，会触发物理内存重新分页，虚拟内存和物理是不是要重新映射？ 如果需要重新映射，那操作系统所有task 的虚拟内存是不是都需要映射，这样的话 映射期间所有的功能都无法使用，映射的时候会不会很长？<br>2:  上面说当要读取特定的页，却发现数据并没有加载到物理内存里的时候，就会触发一个来自于CPU 的缺页错误<br>这里的虚拟内存页，是不是有类似序号的东西，要不然发生页缺失的时候怎么知道接下来加载的是哪一页？<br><br></div> <span class="time">2019-05-19</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/03/11/f58c6278.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">闫循鸣</span> </div> <div class="bd">640k内存，如果我的程序写了一个1M的字符串求length()   指令加数据大于640k。内存不就oom了吗？<br></div> <span class="time">2019-05-18</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/94/43/46a7d0a8.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">暴风雪</span> </div> <div class="bd">2.进行交换，把对象交换到虚拟内存和“指令用到的内存地址叫虚拟内存”是同一块地方吗？<br></div> <span class="time">2019-05-17</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/94/43/46a7d0a8.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">暴风雪</span> </div> <div class="bd">老师，您好！通读全文，我有两个疑问想请假下您。<br>1.既然有了虚拟内存和物理内存作映射，为什么还要要求物理内存是连续的？如果不需要连续的物理内存，那么内存碎片的问题就不存在了。<br>2.<br></div> <span class="time">2019-05-17</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">暴风雪同学你好，映射不是一个byte一个byte来映射，而是映射一头一位的地址，不然映射表就太大了。映射到一头一尾中间的整段物理内存需要是连续的</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/ec/2a/b11d5ad8.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">曾经瘦过</span> </div> <div class="bd">感觉这一讲的内容 基本都是 《现代操作系统》 中关于内存 部分的内容 <br></div> <span class="time">2019-05-16</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">组成原理里的内存部分还是比操作系统要简单很多的，想要深入理解还是要仔细看看操作系统</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/17/08/e8/ebb75f2d.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Forever</span> </div> <div class="bd">能详细讲讲JVM的类加载器吗?期待~~~<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">JVM的class loader的资料网上还是很多的，这个其实完全是个应用层问题，不太适合放到组成原理里面</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJayib1ZcRfOaoLsdsWZokiaO5tLAdC4uNAicQJRIVXrz9fIchib7QwXibnRrsJaoh5TUlia7faUf36g8Bw/132" class="avatar"> <div class="info"> <div class="hd"><span class="username">明月</span> </div> <div class="bd">这里说的程序是指进程还是什么？<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">可以认为是一个进程</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/28/2a/173ea0e1.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">张立昊Leon</span> </div> <div class="bd">感觉JVM应该不需要考虑内存的分页问题，设定个可使用内存值的上限，只要不超过这个上限都可以直接向操作系统申请，操作系统给出一块内存可以直接认为是连续的，底层的映射关系可以让操作系统自己去解决<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">对，jvm对于操作系统也只是一个应用程序而已</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">盛</span> </div> <div class="bd">之前有了解物理内存、虚拟内存、段、页、块之间的关系：只是没想到之间的调度还需要程序并且需要消耗一部分空间；长知识了。<br></div> <span class="time">2019-05-15</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">调度其实是由TLB这样的硬件完成的，不过存放这些映射关系也要占空间</p> <p class="reply-time">2019-05-17</p> </div> </div> </li>  </ul> </div> </div> </div> </div> </div> </body> </html>
